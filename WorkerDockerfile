FROM ruby:2.4-stretch

ENV PYTHONPATH="/code"
ADD . /code

RUN gem install bundle vmfloaty

ADD ssh/config /root/.ssh/config
ADD ssh/id_rsa-acceptance /root/.ssh/id_rsa-acceptance
ADD ssh/id_rsa-elsabuilder /root/.ssh/id_rsa
ADD ssh/id_rsa-elsabuilder.pub /root/.ssh/id_rsa.pub

WORKDIR /code

RUN set -ex \
  && apt-get update \
  && apt-get install -y --no-install-recommends python-dev python-pip python-setuptools python-wheel \
  && rm -rf /var/lib/apt/lists/*

RUN pip install -r service-requirements.txt

ENTRYPOINT celery worker --workdir /code -A tasks.frankenbuild
